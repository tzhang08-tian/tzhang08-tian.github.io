<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<style>
  :root { --bg:#0f1115; --card:#151923; --border:#232838; --white:#ffffff; }
  *{box-sizing:border-box;margin:0;padding:0}

  body{background:rgba(68, 61, 60, 0.8);color:var(--white);-webkit-font-smoothing:antialiased;}

  main{max-width:1100px;margin:60px auto;padding:0 16px;display:flex;flex-direction:column;gap:80px;}

  button{width:60px;height:60px;background:rgba(53, 44, 44, 0.8);border:1px solid var(--border);border-radius:0;cursor:pointer;align-self:center;}

  button:hover{border-color:#3a425e;}
  .layer{display:flex;flex-direction:column;align-items:center;gap:24px;}
  .tracks{display:flex;flex-direction:column;gap:40px;width:100%;}
  .bar{position:relative;width:100%;height:50px;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--white);}
  .bar div{position:absolute;top:0;left:0;height:100%;border-radius:0;}
  .rowbar{display:flex;width:100%;gap:8px;}
  .tile{flex:1;height:40px;display:flex;align-items:center;justify-content:center;font-size:16px;color:black;border:1px solid var(--border);}

</style>
</head>
<body>
<main>
  <div class="layer">
    <button id="btnStage1"></button>
    <div id="tracks" class="tracks"></div>
  </div>

  <div class="layer">
    <button id="btnPickOnePerTrack"></button>
    <div id="grid8" class="tracks"></div>
  </div>

  <div class="layer">
    <button id="btnSplit6"></button>
    <div id="splitRows" class="tracks"></div>
  </div>

  <div class="layer">
    <button id="btnPick1of6"></button>
  </div>

  <div class="layer">
    <button id="btnComposeFinal"></button>
    <div id="finals" class="tracks"></div>
  </div>

</main>

<script>
/* ===== 常量与工具 ===== */
const N = 4;
const SEG30 = 30;
const DUR_RANGE = [120, 360];

const rand = (a,b) => Math.random()*(b-a)+a;
const randi = (a,b) => Math.floor(rand(a,b));
const fmt = sec => {
  sec = Math.max(0, sec|0);
  const m = (sec/60)|0;
  const s = sec%60|0;
  return `${m}:${String(s).padStart(2,'0')}`;
};

/* HSL 随机色轮 */
const randHue = () => randi(0, 360);
// 使用 CSS Color 4 空格语法，现代浏览器均已支持
const hsl = (h, s = 70, l = 55) => `hsl(${h} ${s}% ${l}%)`;
const brightenHSL = (h, baseS = 70, baseL = 55) =>
  hsl(h, Math.min(baseS + 20, 100), Math.min(baseL + 20, 95));
const baseHSL = (h) => hsl(h, 30, 20); // 底色更暗，便于读数

/* ===== 全局状态 ===== */
let tracks = [];                 // 每条轨：{dur, baseHue, baseColor, segs:[{start,end,hue,color}, {..}]}
let pickIdxs = [null,null,null,null];
let pieces = [null,null,null,null]; // 每条轨六等分后的 6 个格：{idx, hue, color}
let pick6   = [null,null,null,null];



const $tracks = document.getElementById('tracks');
const $grid8 = document.getElementById('grid8');
const $splitRows = document.getElementById('splitRows');
const $finals = document.getElementById('finals');

/* 生成一条轨 */
function genTrack() {
  const dur = randi(DUR_RANGE[0], DUR_RANGE[1] + 1);
  const baseHue = randHue();
  return { dur, baseHue, baseColor: baseHSL(baseHue), segs: [null, null] };
}


/* 阶段1：为每条轨生成两个 30s 片段 */
function stage1() {
  tracks = Array.from({length:N}, () => genTrack());

  tracks.forEach(t => {
    for (let k = 0; k < 2; k++) {
      const d = t.dur;
      let start = 0;
      if (d > SEG30) {
        const raw = rand(0, d);
        const maxStart = d - SEG30;
        start = Math.min(raw, maxStart);
      }
      start = Math.max(0, Math.floor(start));
      const end = Math.min(d, start + SEG30);

      // ★ 用同一随机色相生成片段色（可读性好）
      const hue = randHue();
      const color = hsl(hue, 70, 55);

      t.segs[k] = { start, end, hue, color };
    }
  });

  pickIdxs = [null,null,null,null];
  pieces = [null,null,null,null];
  pick6 = [null,null,null,null];

  renderTimelines();
}

/* 渲染时间条（阶段1可视化） */
function renderTimelines() {
  $tracks.innerHTML = '';
  tracks.forEach((t) => {
    const bar = document.createElement('div');
    bar.className = 'bar';

    // 底色背景（整条）
    const bg = document.createElement('div');
    bg.style.background = t.baseColor;
    bg.style.width = '100%';
    bg.style.height = '100%';
    bg.style.left = '0';
    bg.style.top = '0';
    bg.style.position = 'absolute';
    bar.appendChild(bg);

    // 两段 30s 片段
    t.segs.forEach(seg => {
      const segEl = document.createElement('div');
      segEl.style.position = 'absolute';
      segEl.style.top = '0';
      segEl.style.left = `${(seg.start / t.dur) * 100}%`;
      segEl.style.width = `${((seg.end - seg.start) / t.dur) * 100}%`;
      segEl.style.height = '100%';
      segEl.style.background = seg.color;
      bar.appendChild(segEl);
    });

    // 居中只显示数字（时间）
    const label = document.createElement('span');
    label.textContent = t.segs
      .map(s => `${fmt(s.start)} → ${fmt(s.end)}`)
      .join('    ');
    label.style.position = 'relative'; // 让文字在色块之上
    label.style.zIndex = '1';
    bar.appendChild(label);

    $tracks.appendChild(bar);
  });
}

/* 阶段2：每条随机选一段 */
function randomPickOnePerTrack() {
  if (!tracks.length) return;
  pickIdxs = tracks.map(() => Math.random() < 0.5 ? 0 : 1);

  $grid8.innerHTML = '';
  tracks.forEach((t, i) => {
    const seg = t.segs[pickIdxs[i]];

    const bar = document.createElement('div');
    bar.className = 'bar';

    const segEl = document.createElement('div');
    segEl.style.position = 'absolute';
    segEl.style.left = '0';
    segEl.style.top = '0';
    segEl.style.width = '100%';
    segEl.style.height = '100%';
    segEl.style.background = seg.color;
    bar.appendChild(segEl);

    const label = document.createElement('span');
    label.textContent = `${fmt(seg.start)} → ${fmt(seg.end)}`;
    label.style.position = 'relative';
    label.style.zIndex = '1';
    bar.appendChild(label);

    $grid8.appendChild(bar);
  });
}

/* 阶段3：把选中的段六等分（这里只存 1..6 编号与色相/颜色） */
function splitSelectedInto6() {
  if (pickIdxs.some(x => x === null)) return;

  pieces = tracks.map((t, i) => {
    const seg = t.segs[pickIdxs[i]];
    const arr = Array.from({length:6}, (_, j) => ({
      idx: j + 1,
      hue: seg.hue,     // 保存色相，便于同色相高亮
      color: seg.color
    }));
    return arr;
  });

  pick6 = [null,null,null,null];
  renderSplitRows();
}

/* 阶段4：六选一（每条随机挑 1 个） */
function randomPick1of6() {
  if (!pieces[0]) return;
  pick6 = pieces.map(() => randi(0, 6));
  renderSplitRows();
}

/* 渲染“六等分”网格 */
function renderSplitRows() {
  $splitRows.innerHTML = '';
  pieces.forEach((arr, i) => {
    const row = document.createElement('div');
    row.className = 'rowbar';

    if (!arr) { $splitRows.appendChild(row); return; }

    arr.forEach((piece, j) => {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.style.background = (pick6[i] === j)
        ? brightenHSL(piece.hue, 70, 55)  // 选中格：同色相提亮
        : piece.color;                    // 未选中：原片段色
      tile.textContent = piece.idx;
      row.appendChild(tile);
    });

    $splitRows.appendChild(row);
  });
}

/* 阶段5：最终组合（把四条的选中格打乱后组合） */
function composeFinal() {
  if (pick6.some(x => x === null)) return;

  const chosen = pieces.map((arr, i) => {
    const p = arr[pick6[i]];
    return {
      color: brightenHSL(p.hue, 70, 55),
      pieceNo: pick6[i] + 1
    };
  });

  const arranged = chosen.sort(() => Math.random() - 0.5);

  const row = document.createElement('div');
  row.className = 'rowbar';
  arranged.forEach(item => {
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.style.background = item.color;
    tile.textContent = item.pieceNo;
    row.appendChild(tile);
  });

  $finals.prepend(row);
}

/* 事件绑定 */
document.getElementById('btnStage1').onclick = stage1;
document.getElementById('btnPickOnePerTrack').onclick = randomPickOnePerTrack;
document.getElementById('btnSplit6').onclick = splitSelectedInto6;
document.getElementById('btnPick1of6').onclick = randomPick1of6;
document.getElementById('btnComposeFinal').onclick = composeFinal;
</script>
